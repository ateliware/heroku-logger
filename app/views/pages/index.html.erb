<h1>Magic Logger</h1>

<%= form_tag root_path, method: :get, id: 'filters' do %>
  <%= label_tag :http_method, 'HTTP method' %>
  <%= text_field_tag :http_method, @query_params[:http_method], class: 'form-control' %>
  <%= label_tag :request_id, 'Request ID' %>
  <%= text_field_tag :request_id, @query_params[:request_id], class: 'form-control' %>
  <%= label_tag :status %>
  <%= text_field_tag :status, @query_params[:status], class: 'form-control' %>
  <%= label_tag :host %>
  <%= text_field_tag :host, @query_params[:host], class: 'form-control' %>
  <%= label_tag :path %>
  <%= text_field_tag :path, @query_params[:path], class: 'form-control' %>
  <%= label_tag :fwd, 'FWD' %>
  <%= text_field_tag :fwd, @query_params[:fwd], class: 'form-control' %>

  <%= submit_tag "Filter", class: 'btn btn-primary' %>
<% end %>

<hr>

<div class="panel panel-default">
  <table class="table table-striped table-bordered logs">
    <thead class="thead-dark">
      <th class="timestamp">timestamp</th>
      <th class="http_method">method</th>
      <th class="host">host</th>
      <th class="path">path</th>
      <th class="status">status</th>
    </thead>

    <tbody>
      <% @logs.each do |log| %>
        <% if log.request_id.present? %>
          <tr id="<%= log.id %>" class="log request-log">
            <td class="timestamp"><%= log.timestamp.strftime('%d/%m/%Y - %H:%M:%S %3N') %></td>
            <td class="http_method"><%= log.http_method %></td>
            <td class="host"><%= log.host %></td>
            <td class="path"><%= log.path %></td>
            <td class="status"><%= log.status %></td>
          </tr>
        <% else %>
          <tr id="<%= log.id %>" class="arbitrary-log">
            <% if log.timestamp.present? %>
              <td class="timestamp"><%= log.timestamp.strftime('%d/%m/%Y - %H:%M:%S %3N') %></td>
              <td colspan="5"><%= simple_format(log.to_s) %></td>
            <% else %>
              <td><%= simple_format(log.raw) %></td>
            <% end %>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>

<% if @logs.size == @per_page %>
  <a class="btn btn-block btn-primary" href='/?per_page=<%= @per_page + Kaminari.config.default_per_page %>&before_log=<%= @logs.first.id %><%= "&utf8=âœ“&http_method=#{@query_params[:http_method]}&request_id=#{@query_params[:request_id]}&status=#{@query_params[:status]}&host=#{@query_params[:host]}&path=#{@query_params[:path]}&fwd=#{@query_params[:fwd]}&commit=Filter" %>#<%= @logs.last.id %>'>more...</a>
<% end %>

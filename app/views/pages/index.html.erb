<h1>Magic Logger</h1>

<%= form_tag root_path, method: :get, id: 'filters' do %>
  <%= label_tag :http_method, 'HTTP method' %>
  <%= text_field_tag :http_method, @query_params[:http_method], class: 'form-control' %>
  <%= label_tag :request_id, 'Request ID' %>
  <%= text_field_tag :request_id, @query_params[:request_id], class: 'form-control' %>
  <%= label_tag :status %>
  <%= text_field_tag :status, @query_params[:status], class: 'form-control' %>
  <%= label_tag :host %>
  <%= text_field_tag :host, @query_params[:host], class: 'form-control' %>
  <%= label_tag :path %>
  <%= text_field_tag :path, @query_params[:path], class: 'form-control' %>
  <%= label_tag :fwd, 'FWD' %>
  <%= text_field_tag :fwd, @query_params[:fwd], class: 'form-control' %>

  <%= submit_tag "Filter", class: 'btn btn-primary' %>
<% end %>

<hr>

<div class="panel panel-default">
  <table class="table table-striped table-bordered">
    <thead class="thead-dark">
      <th>timestamp</th>
      <th>http_method</th>
      <th>host</th>
      <th>path</th>
      <th>status</th>
      <th>fwd</th>
      <th>request_id</th>
    </thead>

    <tbody>
      <% @logs.each do |log| %>
        <% if log.request_id.present? %>
          <tr id="<%= log.id %>" class="log">
            <td><%= log.timestamp.strftime('%d/%m/%Y - %H:%M:%S %3N') %></td>
            <td><%= log.http_method %></td>
            <td><%= log.host %></td>
            <td><%= log.path %></td>
            <td><%= log.status %></td>
            <td><%= log.fwd %></td>
            <td><%= log.request_id %></td>
          </tr>
        <% else %>
          <tr id="<%= log.id %>">
            <% if log.timestamp.present? %>
              <td colspan="1"><%= log.timestamp.strftime('%d/%m/%Y - %H:%M:%S %3N') %></td>
              <td colspan="6"><%= simple_format(log.to_s) %></td>
            <% else %>
              <td colspan="7"><%= simple_format(log.raw) %></td>
            <% end %>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>

<% if @logs.size >= @per_page %>
  <a class="btn btn-block btn-primary" href="/?per_page=<%= @per_page + Kaminari.config.default_per_page %>&before_log=<%= @logs.first.id %>#<%= @logs.last.id %>">more...</a>
<% end %>
